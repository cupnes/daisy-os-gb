# バイナリ生物学のGB向け実装について
- バイトオーダーはリトルエンディアン

## データ構造
### `cell`: 細胞
| オフセット | 名前 | 内容 | 型 | 初期細胞[^init_cell]の値 |
| --- | --- | --- | --- | --- |
| 0 | `next_cell_addr` | 次の細胞のアドレス | アドレス(2バイト) | 自分自身の先頭アドレス |
| 2 | `flags` | フラグ | ビットフィールド(1バイト) | 0x01 |
| 3 | `tile_x` | タイル座標(X) | 符号なし整数(1バイト) | 0x0a(10) |
| 4 | `tile_y` | タイル座標(Y) | 符号なし整数(1バイト) | 0x09 |
| 5 | `life_duration` | 寿命 | 符号なし整数(1バイト) | 0x0a(10) |
| 6 | `life_left` | 余命 | 符号なし整数(1バイト) | 0x0a(10) |
| 7 | `fitness` | 適応度 | 符号なし整数(1バイト) | 0x64(100) |
| 8 | `tile_num` | タイル番号 | 符号なし整数(1バイト) | 0x8b(細胞タイル) |
| 9 | `bin_size` | 機械語バイナリサイズ | 符号なし整数(1バイト) | 0x05 |
| 10 | `bin_data` | 機械語バイナリ | 機械語バイナリ列(5バイト) | 0x3e 8b cd <TBD[^a_set_tile_num_to_cell]>(自身のタイル番号を細胞タイルへ変更する) |
| 15 | `collected_flags` | 機械語バイナリの各バイトの取得フラグ | ビットフィールド(1バイト) | 0x00 |
- サイズ：16バイト
[^init_cell]: 開始時に存在する細胞
[^a_set_tile_num_to_cell]: 指定されたタイル番号を現在注目している細胞へ設定する関数のアドレス(2バイト)

#### `next_cell_addr`: 次の細胞のアドレス
- これにより片方向の循環リストを構成する
- 1つ目の要素のアドレスを記憶しておく
  - リストを走査する際、1つ目に戻ってきたかどうかはこのアドレスとの比較で確認する

#### `flags`: フラグ
| ビット | 名前 | 内容 | 初期細胞の値 |
| --- | --- | --- | --- |
| 7-1 | - | 予約 | 0b0000 000 |
| 0 | `alive` | この細胞が生きている(=1)か否(=0)か | 1 |

#### `tile_x`・`tile_y`: タイル座標(X,Y)
- 8x8pxのタイル何個目か(0始まり)で表す座標系
- GBの背景マップサイズは256x256pxなので、タイル座標として取り得る値はX・Y共に0(0x00)〜31(0x1f)
  - その内、表示領域は160x144pxなので、表示されるのは20(0x14)x18(0x12)個のタイルの領域
- 変換式
  - ※ TILE_WIDTH = TILE_HEIGHT = 8
  - ピクセル座標(Px,Py) → タイル座標(Tx,Ty)
    - Tx = Px / TILE_WIDTH (小数点以下切り捨て)
    - Ty = Py / TILE_HEIGHT (小数点以下切り捨て)
  - タイル座標(Tx,Ty) → ピクセル座標(Px,Py)
    - Px = Tx * TILE_WIDTH
    - Py = Ty * TILE_HEIGHT
    - ※ この時、(Px,Py)は該当タイルの左上座標

#### `bin_data`: 機械語バイナリ
- `ret`命令は含まない
  - 「代謝/運動」時に実行用の領域へコピーし、その際に末尾にret命令を追加する

#### `collected_flags`: 機械語バイナリ列の各バイトの取得フラグ
- 下位のビットから順に`bin_data`の1バイト目、2バイト目、3バイト目、・・・の取得済みを示すフラグ

### システム変数
| 名前 | 内容 | 型 | 初期値 |
| --- | --- | --- | --- |
| `cur_cell` | 現在対象としている細胞番号 | 符号なし整数(1バイト) | 初期細胞の細胞番号(0) |
| `cur_cell_addr` | 現在対象としている細胞アドレス | アドレス(2バイト) | 初期細胞のアドレス |

### 備考
- 細胞番号と細胞アドレスの関係
  - 細胞データ領域先頭アドレス + (細胞番号 * 細胞データ構造サイズ(16バイト)) = 細胞アドレス

## 振る舞い
### `death`: 死
- 処理内容
  - 現在の細胞の`alive`フラグをクリアする

### `growth`: 成長
- 引数
  | レジスタ | 内容 |
  | --- | --- |
  | A | 取得したコード化合物 |
- 処理内容
  - 現在の細胞の`bin_data`の中に「取得したコード化合物」と同じものが存在したら、対応する`collected_flags`のビットをセットする
